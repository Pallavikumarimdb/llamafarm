name: Generate Prose Changelog

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to generate changelog for (e.g., 0.0.19). Leave empty for latest."
        required: false
        type: string
      model:
        description: "LlamaFarm model to use for generation"
        required: false
        default: ""
        type: string

permissions:
  contents: read

env:
  NX_NO_CLOUD: true

jobs:
  generate-prose-changelog:
    runs-on: gpu-med
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Determine version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            # Strip 'v' prefix from release tag if present
            echo "version=${RELEASE_TAG#v}" >> $GITHUB_OUTPUT
          else
            echo "version=${INPUT_VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Generate prose changelog
        id: generate
        uses: ./.github/actions/prose-changelog
        with:
          version: ${{ steps.version.outputs.version }}
          model: ${{ inputs.model }}

      - name: Add to job summary
        env:
          VERSION: ${{ steps.generate.outputs.version }}
          CHANGELOG: ${{ steps.generate.outputs.prose_changelog }}
        run: |
          echo "## Prose Changelog for v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${CHANGELOG}" >> $GITHUB_STEP_SUMMARY

      - name: Upload prose changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: prose-changelog-${{ steps.generate.outputs.version }}
          path: prose-changelog-*.md
          retention-days: 30
